// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Authentication
model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String?   @unique
  name          String?
  password      String    // hashed password
  role          UserRole  @default(USER)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// SAP Connection Configuration
model SAPConnection {
  id             String         @id @default(uuid())
  name           String         @unique
  connectionType ConnectionType
  
  // Basic connection parameters
  host           String         @map("ashost")
  systemNumber   String         @map("sysnr")
  client         String
  user           String
  password       String         // Consider encrypting in production
  language       String         @default("EN") @map("lang")
  
  // Optional connection parameters
  saprouter      String?
  sncMode        String?        @map("snc_mode")
  sncQop         String?        @map("snc_qop")
  sncMyname      String?        @map("snc_myname")
  sncPartnername String?        @map("snc_partnername")
  trace          String?
  
  // Connection-specific options (stored as JSON)
  poolOptions    Json?          // For POOL type: { low: number, high: number }
  clientOptions  Json?          // For all types: { timeout, bcd, filter, etc. }
  
  // Metadata
  isActive       Boolean        @default(true)
  description    String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  // Relations
  callLogs       CallLog[]
  rfcTemplates   RFCTemplate[]
  
  @@index([connectionType])
  @@index([isActive])
  @@map("sap_connections")
}

enum ConnectionType {
  CLIENT
  POOL
}

// Call History/Logs
model CallLog {
  id           String        @id @default(uuid())
  connectionId String
  connection   SAPConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  // Call details
  rfmName      String        @map("rfm_name")
  parameters   Json?         // Input parameters
  result       Json?         // Output result
  
  // Performance metrics
  duration     Int           // milliseconds
  status       CallStatus
  errorMessage String?       @db.Text
  errorCode    String?
  errorKey     String?
  
  // Metadata
  calledAt     DateTime      @default(now())
  
  @@index([connectionId])
  @@index([status])
  @@index([calledAt])
  @@index([rfmName])
  @@map("call_logs")
}

enum CallStatus {
  SUCCESS
  ERROR
  TIMEOUT
  CANCELLED
}

// RFC API 接口定义 - 简化版本，直接映射 REST API 到 SAP RFC
model RFCTemplate {
  id              String         @id @default(uuid())
  name            String         @unique // 接口名称
  description     String?        // 接口描述
  connectionId    String         // SAP 连接（必填）
  connection      SAPConnection  @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  // RFC 配置
  rfmName         String         @map("rfm_name") // SAP RFC 函数名（必填）
  
  // JSON 映射配置 - 简单的 JSONPath 映射
  inputMapping    Json           @map("input_mapping")  // { "rfcParam": "$.apiField" } 格式
  outputMapping   Json?          @map("output_mapping") // 可选的输出映射，默认返回完整结果
  
  // API 配置
  apiPath         String         @unique @map("api_path") // REST API 路径，例如: /api/external/get-customer
  apiKey          String         @map("api_key") // API 认证密钥
  
  // 元数据
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // 调用历史
  calls           RFCCall[]
  
  @@index([apiPath])
  @@index([isActive])
  @@map("rfc_templates")
}

// RFC 调用记录（从 CallLog 独立出来）
model RFCCall {
  id           String        @id @default(uuid())
  templateId   String?
  template     RFCTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  // 调用详情
  rfmName      String        @map("rfm_name")
  parameters   Json?
  result       Json?
  
  // 性能指标
  duration     Int           // milliseconds
  status       CallStatus
  
  // 详细错误信息
  errorMessage String?       @db.Text      // 主要错误消息
  errorDetails Json?                       // 完整错误对象 { code, key, abapMsgClass, abapMsgType, abapMsgNumber, abapMsgV1-4, stack }
  
  // 请求响应详情
  requestBody  Json?                       // 原始请求 body (仅 external_api 来源)
  
  // 来源
  source       String?       // "web", "api", "external"
  calledBy     String?       // IP 或用户标识
  
  calledAt     DateTime      @default(now())
  
  @@index([templateId])
  @@index([status])
  @@index([calledAt])
  @@map("rfc_calls")
}
