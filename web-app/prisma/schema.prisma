// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Authentication
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  password      String    // hashed password
  role          UserRole  @default(USER)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// SAP Connection Configuration
model SAPConnection {
  id             String         @id @default(uuid())
  name           String         @unique
  connectionType ConnectionType
  
  // Basic connection parameters
  host           String         @map("ashost")
  systemNumber   String         @map("sysnr")
  client         String
  user           String
  password       String         // Consider encrypting in production
  language       String         @default("EN") @map("lang")
  
  // Optional connection parameters
  saprouter      String?
  sncMode        String?        @map("snc_mode")
  sncQop         String?        @map("snc_qop")
  sncMyname      String?        @map("snc_myname")
  sncPartnername String?        @map("snc_partnername")
  trace          String?
  
  // Connection-specific options (stored as JSON)
  poolOptions    Json?          // For POOL type: { low: number, high: number }
  clientOptions  Json?          // For all types: { timeout, bcd, filter, etc. }
  
  // Metadata
  isActive       Boolean        @default(true)
  description    String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  // Relations
  callLogs       CallLog[]
  rfcTemplates   RFCTemplate[]
  
  @@index([connectionType])
  @@index([isActive])
  @@map("sap_connections")
}

enum ConnectionType {
  CLIENT
  POOL
}

// Call History/Logs
model CallLog {
  id           String        @id @default(uuid())
  connectionId String
  connection   SAPConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  // Call details
  rfmName      String        @map("rfm_name")
  parameters   Json?         // Input parameters
  result       Json?         // Output result
  
  // Performance metrics
  duration     Int           // milliseconds
  status       CallStatus
  errorMessage String?       @db.Text
  errorCode    String?
  errorKey     String?
  
  // Metadata
  calledAt     DateTime      @default(now())
  
  @@index([connectionId])
  @@index([status])
  @@index([calledAt])
  @@index([rfmName])
  @@map("call_logs")
}

enum CallStatus {
  SUCCESS
  ERROR
  TIMEOUT
  CANCELLED
}

// RFC Template - 预定义的 RFC 配置
model RFCTemplate {
  id              String         @id @default(uuid())
  name            String         @unique
  description     String?
  connectionId    String
  connection      SAPConnection  @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  // RFC 配置
  rfmName         String         @map("rfm_name")
  parameters      Json?          // 默认参数模板
  
  // RFC 元数据（从 SAP 获取的参数结构）
  inputSchema     Json?          @map("input_schema")  // RFC 输入参数结构
  outputSchema    Json?          @map("output_schema") // RFC 输出参数结构
  
  // JSON 映射配置
  inputMapping    Json?          @map("input_mapping")  // API 输入 -> RFC 输入的映射规则
  outputMapping   Json?          @map("output_mapping") // RFC 输出 -> API 输出的映射规则
  
  // API 配置
  apiPath         String?        @unique @map("api_path") // 例如: /api/rfc/get-customer
  apiKey          String         @map("api_key") // 强制要求 API Key
  
  // 元数据
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // 调用历史
  calls           RFCCall[]
  
  @@index([apiPath])
  @@index([isActive])
  @@map("rfc_templates")
}

// RFC 调用记录（从 CallLog 独立出来）
model RFCCall {
  id           String        @id @default(uuid())
  templateId   String?
  template     RFCTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  // 调用详情
  rfmName      String        @map("rfm_name")
  parameters   Json?
  result       Json?
  
  // 性能指标
  duration     Int           // milliseconds
  status       CallStatus
  errorMessage String?       @db.Text
  
  // 来源
  source       String?       // "web", "api", "external"
  calledBy     String?       // IP 或用户标识
  
  calledAt     DateTime      @default(now())
  
  @@index([templateId])
  @@index([status])
  @@index([calledAt])
  @@map("rfc_calls")
}
